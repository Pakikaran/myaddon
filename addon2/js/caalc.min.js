var HistoryManager=function(){var recordsCount=0,records=[],historyPoint=0,hModule={};function onHistoryClean(){$(".h-placeholder").css("display","block");$(".history-tools").css("display","none")}function onHistoryHasItems(){$(".h-placeholder").css("display","none");$(".history-tools").css("display","block")}function saveRecordsToLocalStorage(){localStorage.setItem("calculatorHistory",JSON.stringify(records))}function addRecord(calculation,result,comment,error){result=result.toString();var noComment=comment===undefined||comment==="",newComment=noComment?"Add Comment":comment,commentClass=noComment?"h-action-no-comment":"h-action-comment",newRecord=document.createElement("li"),link="?"+$.param({calc:calculation}),resString=result.length<50?result:'<a title="'+result+'">'+result.substr(0,50)+" . . .</a>",resultString=(result==="E"?'</span><span class="separator">:</span><span class="calcErr"> Error. '+error:'</span><span class="separator">=</span><span class="calcRes">'+result)+"</span>",newRecordBody='<div><span class="h-index">'+(recordsCount+1)+'</span><span class="remove-history-record">&times;</span> <span  class="record">'+calculation+resultString+'<div class="h-actions"><span class="h-comment-edit-trigger '+commentClass+'">'+newComment+'</span><a class="h-action-no-comment" id="h-comment-link"  href="'+link+'">Link &nbsp;</a></div></div>';$(newRecord).append(newRecordBody);$("#history-box ol").prepend(newRecord);CalculatorUI.utils.createLiActivater(newRecord,"parent");$(newRecord).find(".h-comment-edit-trigger").click(CalculatorUI.onCommentEditTriggerClick);$(newRecord).find(".record").click(CalculatorUI.onRecordClick);$(newRecord).find(".h-index").click(CalculatorUI.onRecordIdClick);$(newRecord).find(".remove-history-record").click(CalculatorUI.onRemoveRecordClick)}hModule.resetHistoryPoint=function(){var children=$("#history").children("li");historyPoint=0;if(children.length>0){children.removeClass("selected");var item=children[historyPoint];item.className+=" selected";item.scrollIntoView(true)}};hModule.moveHistoryPoint=function(step){var v,children=$("#history").children("li");if(children.length>0){children.removeClass("selected");historyPoint+=step;if(historyPoint>children.length){historyPoint=children.length}if(historyPoint<1){historyPoint=1}var item=children[historyPoint-1];item.className+=" selected";item.scrollIntoView(true);v=$(item).find(".record").html();Calculator.setInput(v)}};hModule.renderFromLocalStorage=function(){var count=0;records=$.parseJSON(localStorage.getItem("calculatorHistory"))||[];if(records){$.each(records,function(index,record){addRecord(Calculator.extractInputFromResult(record[0]),record[1],record[2],record[3]);count=count+1;recordsCount=count});if(count>0){Calculator.setScope("ans",records[count-1][1]);onHistoryHasItems()}else{onHistoryClean()}}};hModule.registerChange=function(calculation,result,error){addRecord(calculation,result,"",error);records.push([calculation,result,"",error]);recordsCount+=1;saveRecordsToLocalStorage();onHistoryHasItems()};hModule.updateComment=function(index,comment){comment=comment==="Save"?"":comment;records[index][2]=comment;saveRecordsToLocalStorage()};hModule.cleanHistory=function(){records=[];recordsCount=0;saveRecordsToLocalStorage();$("#history-box ol").html("");onHistoryClean()};hModule.removeHistoryRecord=function(index){records.splice(index,1);recordsCount-=1;saveRecordsToLocalStorage();$("#history").find("li").each(function(){var itemIndex=parseInt($(this).find(".h-index").html(),10);if(itemIndex>index){$(this).find(".h-index").html(itemIndex-1)}});if(recordsCount===0){hModule.cleanHistory()}};return hModule}(),Calculator=function(){math.config({number:"bignumber"});var cModule={},funcEditLined=false,formatOptions={notation:"auto",fraction:"ratio",precision:99,exponential:{lower:1e-99,upper:1e99}},parser=math.parser(),parserScope={binBase:function(n,to,from){var s,number=parseInt(n.toString(),from||10);s=number.toString(to);switch(parseInt(to,10)){case 10:return number;case 16:return"0x"+s.toUpperCase();case 8:return"0c"+s;case 2:return"0b"+s;default:return s}}};function inputFormat(inputValue){var oCnt=(inputValue+"(").match(/\(/gi).length,cCnt=(inputValue+")").match(/\)/gi).length;if(oCnt==cCnt+1){inputValue+=")"}inputValue=$.trim(inputValue);inputValue=inputValue.replace(/\s\s/g," ");inputValue=inputValue.replace(/([\W\w]*)=$/g,"$1");inputValue=inputValue.replace(/0x(-?\w+)/g,'dec("$1",16)');inputValue=inputValue.replace(/0b(-?\d+)/g,'dec("$1",2)');inputValue=inputValue.replace(/0c(-?\d+)/g,'dec("$1",8)');inputValue=inputValue.replace(/#([a-z\d\.]+|\([a-z\d\(\)\.\-\*\+\/]+\))/g,"$1 deg ");inputValue=inputValue.replace(/%/g,"/100*");inputValue=inputValue.replace(/lg/g,"log10");inputValue=inputValue.replace(/ln/g,"log");if(inputValue.slice(-1)==="*"){inputValue=inputValue.replace(/([\w\W]*)\*/g,"($1)*($1)")}return inputValue}cModule.normalizeInputFontSize=function(){var latexInput=$("#input-latex"),style=$("#input")[0].style,styleLatex=latexInput[0].style,length=Calculator.getInput().length;if(length>97){style.font="bold 14px 'Century Gothic', Helvetica, sans";styleLatex.fontSize="12px"}else if(length>80){style.font="bold 16px 'Century Gothic', Helvetica, sans";styleLatex.fontSize="14px"}else if(length>=40){style.font="bold 20px 'Century Gothic', Helvetica, sans";styleLatex.fontSize="18px"}else if(length>=24){style.font="bold 40px 'Century Gothic', Helvetica, sans";styleLatex.fontSize="40px"}else if(length>=20){style.fontSize="64px";styleLatex.fontSize="50px"}else{style.fontSize="64px";styleLatex.fontSize="62px"}var jaxDisplay=$(".MathJax_Display");latexInput.css("padding-top",jaxDisplay.height()>90?15:25);while(parseInt(styleLatex.fontSize,10)>4&&jaxDisplay.height()>latexInput.height()-10){latexInput.css("fontSize",parseInt(styleLatex.fontSize,10)-2);console.log(jaxDisplay.height())}};function inputChange(evt){cModule.normalizeInputFontSize();if(evt.keyCode===13||evt==="manual"){cModule.calculate();HistoryManager.resetHistoryPoint()}else if(evt.keyCode===38){HistoryManager.moveHistoryPoint(-1)}else if(evt.keyCode===40){HistoryManager.moveHistoryPoint(1)}else if(evt.keyCode===27){cModule.setInput("");HistoryManager.resetHistoryPoint()}else{HistoryManager.resetHistoryPoint()}}cModule.init=function(){$(document).keydown(function(e){if(e.keyCode===72&&e.ctrlKey){e.preventDefault();e.stopPropagation();Calculator.showHelp("help")}else if(e.keyCode===76&&e.ctrlKey){e.preventDefault();e.stopPropagation();Calculator.showTex(cModule.getInput())}else if(e.keyCode===75&&e.ctrlKey){e.preventDefault();e.stopPropagation();CalculatorUI.toggleKeypad()}else if(e.keyCode===77&&e.ctrlKey){e.preventDefault();e.stopPropagation();CalculatorUI.toggleLatex()}});$(document).keyup(inputChange);cModule.evalCustomFunctions();$.msgbox({id:"flot",title:"Graph",content:'<div class="demo-container"><div id="placeholder" class="demo-placeholder"></div></div>',type:"html",keyEvents:{Esc:"close",Space:"close",Enter:"close"},width:Math.min($(window).width()-10,600),height:Math.min($(window).height()-10,500),open:false,transition:"linear"});$.msgbox({id:"tex",title:"Formula",content:'<div class="demo-container"><div id="tex-placeholder" class="demo-placeholder"></div></div>',type:"html",keyEvents:{Esc:"close",Space:"close",Enter:"close"},width:Math.min($(window).width()-20,700),height:Math.min($(window).height()-20,250),open:false,transition:"linear"});$.msgbox({id:"help",title:"Help",type:"info",content:" ",keyEvents:{Esc:"close",Space:"close",Enter:"close"},width:Math.min($(window).width()-20,500),open:false});$.msgbox({id:"error",title:"Error",type:"error",content:" ",keyEvents:{Esc:"close",Space:"close",Enter:"close"},width:Math.min($(window).width()-20,500),open:false})};cModule.setLatexInput=function(inputText,enforce){var inputLatex=$("#input-latex");if(enforce||!inputLatex.hasClass("hidden")){try{var latex=math.parse(inputText).expr.toTex();inputLatex.html("$$"+latex+"$$")}catch(ex){inputLatex.html("$$"+inputText+"$$");console.log("Can't parse ",inputText)}MathJax.Hub.Queue(["Typeset",MathJax.Hub,"input-latex"])}};cModule.setFracDecMode=function(mode){math.config({number:mode?"fraction":"bignumber"});formatOptions.fraction=mode?"ratio":"decimal"};cModule.setInput=function(val){var inputText=val.toString();$("#input").val(inputText).focus();cModule.setLatexInput(inputText,false);cModule.normalizeInputFontSize()};cModule.getInput=function(){return $("#input").val()};cModule.showTex=function(input,result){try{var latex=null;try{latex=math.parse(input).expr.toTex();if(result){latex+="="+math.parse(result).expr.toTex()}}catch(err){console.log("error2: "+err.toString())}var pretty=$("#tex-placeholder")[0];if(pretty){pretty.innerHTML="$$"+latex+"$$";$.msgbox("tex").open()}else{$.msgbox("tex").open();$("#tex-placeholder")[0].innerHTML="$$"+latex+"$$"}MathJax.Hub.Queue(["Typeset",MathJax.Hub,"tex-placeholder"])}catch(e){$.msgbox("error").content(e);$.msgbox("error").open()}};cModule.showFlot=function(par){try{var points=[],res=[],i=0,params=par.split(","),funcs=params[0].split(";"),num=funcs.length,rng=params[1]||"0:100",rngs=rng.split(":"),fromStart=math.number(parser.eval(rngs[0])),fromEnd=math.number(parser.eval(rngs[1]||"100")),fromStep=math.number(parser.eval(params[2]||"0.5")),varx=params[3]||"x",scopes=params[4]?params[4].split(";"):[];for(i=0;i<num;i+=1){var p=[];points.push(p);res.push({label:funcs[i],data:p});funcs[i]=math.compile(funcs[i])}for(var x=fromStart;x<fromEnd;x+=fromStep){parser.set(varx,x);if(scopes.length>0){for(var scope in scopes){parser.eval(scopes[scope])}}for(i=0;i<num;i+=1){points[i].push([x,funcs[i].eval(parser.scope)])}}$.msgbox("flot").open();$.plot("#placeholder",res,{series:{lines:{show:true},points:{show:false}},crosshair:{mode:"xy"},grid:{hoverable:true,autoHighlight:false}})}catch(e){$.msgbox("error").content(e);$.msgbox("error").open()}};function showHelpMessage(output){$.msgbox("help").content(output);$.msgbox("help").open()}cModule.showHelp=function(input){var output="E";try{if(input.toLowerCase().indexOf("plot")>0){output=" <b>plot(f(x);....;g(x),from:to,step)</b><br><br>"+" Try, for example: <br><br>"+" <ul><li>  plot(cos(x)) is the same as plot(cos(x),-100:100,0.5) </li>"+" <li>  plot(cos(x);sin(x))</li>"+" <li>  plot(x^2,-10,10)  </li>"+"<li>  plot(sin(x);tan(x);10*sign(x),-10:10,0.1) </li></ul>"}else output=parser.eval(input)}catch(e){}if(output==="E"||typeof output==="function"){var ls=[];$.each(math,function(index){ls.push(index)});output="Here is a list of suppported functions. Run '<b>help(<i>name</i>)</b>' for any of them to get a summary.</br></br>"+ls.sort().join(", ")+"<br><br><h3>Some keyboard shortcuts:</h3>"+"<b>UP/DOWN</b> - next/previous expression<br>"+"<b>CTRL K</b> - show/hide keypad<br>"+"<b>CTRL L</b> - show expresion in pretty way with LaTex<br>"+"<b>CTRL M</b> - switch to pretty mode (experimental)<br>"+"<b>CTRL H</b> - show this message<br>"}else{output=output.toString().replace(/\n/g,"</br>")}showHelpMessage(output)};cModule.setScope=function(param,value){parser.scope[param]=parser.eval(value)};cModule.getScope=function(){return parser.scope};cModule.calculate=function(){var inputValue=cModule.getInput(),ipStr=inputValue.trim(),valid=/^[\w\-\*\+\/\(\)\[\]\.,\?=\^!#'":;<>\s\%]+$/.test(inputValue),originalInput,output,error="";if(ipStr.indexOf("help")===0){Calculator.showHelp(inputValue)}else if(ipStr==="scope"){var output="";$.each(parser.scope,function(key,value){if(typeof value==="function"){value="function"}output+="<b>"+key+"</b>: "+value+"<br>"});showHelpMessage(output)}else if(ipStr.indexOf("plot(")===0){var plotParams=ipStr.substring(ipStr.indexOf("plot(")+5,ipStr.lastIndexOf(")"));Calculator.showFlot(plotParams)}else if(valid&&inputValue!==""){originalInput=inputValue;output="E";inputValue=inputFormat(inputValue);console.log("input: "+inputValue);try{var answer=parser.eval(inputValue);parser.scope.ans=answer;output=math.format(answer,formatOptions)}catch(e){console.log("input: "+inputValue+", error: "+e.message);output="E";error=e.message}HistoryManager.registerChange(inputValue,output,error);cModule.setInput(output)}else{console.log("invalid input:"+inputValue);cModule.setInput("E")}$("#input").select()};cModule.evalCustomFunctions=function(){var script=localStorage.getItem("customFuncs"),scope={functions:[]};try{new Function(script).call(scope)}catch(e){console.log("error in user script:"+e.message)}$.each(scope,function(a,b){try{if(a==="functions"){$.each(b,function(i,s){parser.eval(s)})}else if(a==="options"){if(b.input&&b.input=="decimal"){}if($.isNumeric(b.precision)){formatOptions.precision=b.precision}if(b.notation){formatOptions.notation=b.notation}if(b.exponential){formatOptions.exponential=b.exponential}if(b.output){}}else{if(parser.get(a)){console.log("Warning: Custom method overrides standard "+($.isFunction(b)?"function ":"variable ")+a)}parser.set(a,b)}}catch(e){console.log("error in user script: with "+a+" defined as '"+b+"'")}});$.each(parserScope,function(index,record){parser.set(index,record)});parser.eval("bin(x) = binBase(x, 2)");parser.eval("dec(x,y) = binBase(x, 10, y)");parser.eval("hex(x) = binBase(x, 16)");parser.eval("base(x,y,z) = binBase(x, y, z)")};cModule.extractInputFromResult=function(str){var cutIndex=str?str.lastIndexOf("="):-1,input=str;if(cutIndex>-1){input=input.substr(0,cutIndex).trim()}return input};return cModule}(),CalculatorUI=function(){var uiModule={};function getURLParameter(name){return decodeURIComponent((new RegExp("[?|&]"+name+"="+"([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null}function holdit(btn,action,start,speedup){var t,repeat=function(){if(start<250){action()}t=setTimeout(repeat,start);start=start/speedup};btn.onmousedown=function(){repeat()};btn.onmouseup=function(){clearTimeout(t);start=500}}uiModule.init=function(){Calculator.init();uiModule.checkPendingOmniboxInput();uiModule.initOutput();uiModule.initKeypad()};uiModule.checkPendingOmniboxInput=function(){var param=getURLParameter("calc");if(!param){param=localStorage.getItem("fromOmnibox")}if(param){Calculator.setInput(param);$("#input").change()}else{$("#input").focus();$("#input").select()}};uiModule.initOutput=function(){HistoryManager.renderFromLocalStorage();$("#clean").click(HistoryManager.cleanHistory)};uiModule.onCommentEditTriggerClick=function(){var trigger,commentEditor,input,index,comment,currentValue,s,btn=$(this);if(btn.html()==="Save"){input=btn.parent().children("input");s=btn.parent().parent().children(".h-index").html();index=parseInt(s,10)-1;comment=input.val();HistoryManager.updateComment(index,comment);if(comment===""||comment==="Save"){comment="Add comment";btn.removeClass("h-action-comment");btn.addClass("h-action-no-comment")}else{btn.removeClass("h-action-no-comment");btn.addClass("h-action-comment")}btn.html(comment);input.remove()}else{trigger=this;commentEditor=document.createElement("input");$(commentEditor).addClass("h-comment-editor");$(commentEditor).keypress(function(e){if(e.keyCode===13){$(trigger).click()}});currentValue=btn.html();if(currentValue!=="Add Comment"){$(commentEditor).val(currentValue)}btn.parent().prepend(commentEditor);$(commentEditor).focus();btn.html("Save")}};uiModule.onRecordClick=function(){var log=$(this).html(),input=Calculator.extractInputFromResult(log);Calculator.setInput(input);Calculator.normalizeInputFontSize()};uiModule.onRecordIdClick=function(){var parent=$(this).parent();var input=parent.find(".record").html(),result=parent.find(".calcRes").html();Calculator.showTex(input,result)};uiModule.onRemoveRecordClick=function(){var parent=$(this).parent().parent(),index=parseInt(parent.find(".h-index").html(),10);HistoryManager.removeHistoryRecord(index);parent.fadeOut("fast")};uiModule.toggleLatex=function(){$("#input-latex").toggleClass("hidden");$("#input").toggleClass("hidden");$("#latex-icon").toggleClass("opaque");Calculator.setLatexInput(Calculator.getInput(),true);Calculator.normalizeInputFontSize()};uiModule.toggleKeypad=function(){var history=$("#history-box"),input_buttons=$("#input-buttons");input_buttons.toggleClass("visible");$("#keypad-icon").toggleClass("opaque");history.toggleClass("halfsize");var isVisible=input_buttons.hasClass("visible");if($.browser.mobile&&isVisible){$("#input").attr("readonly",true)}else{$("#input").attr("readonly",false)}localStorage.setItem("calculatorKeyPad",isVisible);$("#input").focus()};uiModule.initKeypad=function(){if($.browser.mobile&&input_buttons.hasClass("visible")){$("#input").attr("readonly",true)}$("#keypad-icon").click(uiModule.toggleKeypad);$("#latex-icon").click(uiModule.toggleLatex);var useKeypad=localStorage.getItem("calculatorKeyPad");if(useKeypad===null||useKeypad==="true"){$("#keypad-icon").click()}$(".kp-button").click(uiModule.keypadKeyClick);$("#clear-keypad-button").dblclick(function(){Calculator.setInput("")});holdit($("#clear-keypad-button"),function(){Calculator.setInput("")},500,2)};uiModule.keypadKeyClick=function(){var button=$(this),stringToAppend=button.attr("stringToAppend")||button.html(),stringToPrefix=button.attr("stringToPrefix")||"",inputValue=Calculator.getInput(),input=$("#input")[0];if(button.hasClass("kp-fracdec")){if(button.hasClass("frac")){button.removeClass("frac");button.html("DEC<br><sub>frac<sub>");Calculator.setFracDecMode(false)}else{button.addClass("frac");button.html("FRAC<br><sub>dec<sub>");Calculator.setFracDecMode(true)}return}if(button.hasClass("kp-eql")){Calculator.calculate();return}var selectionStart=-1;if(button.hasClass("kp-back")){if(input.selectionEnd!==input.selectionStart){inputValue=inputValue.substr(0,input.selectionStart)+inputValue.substr(input.selectionEnd,inputValue.length)}else if(inputValue.length>0){inputValue=inputValue.substr(0,input.selectionStart-1)+inputValue.substr(input.selectionEnd,inputValue.length)}selectionStart=input.selectionStart-1}else if($.isNumeric(inputValue.replace(",",""))&&stringToAppend.length>1&&stringToAppend.lastIndexOf("(")===stringToAppend.length-1){inputValue=stringToAppend+inputValue+")"}else{if(inputValue==="0"||inputValue==="E"){inputValue=""}if(input.selectionEnd!==input.selectionStart){inputValue=inputValue.substr(0,input.selectionStart)+stringToAppend+inputValue.substr(input.selectionEnd,inputValue.length)}else{inputValue=inputValue.substr(0,input.selectionStart)+stringToAppend+inputValue.substr(input.selectionEnd,inputValue.length)}}Calculator.setInput(inputValue);if(selectionStart>0){input.selectionStart=selectionStart;input.selectionEnd=selectionStart}};uiModule.utils={createLiActivater:function(selector,forSelector){$(selector).find(".record").each(function(){var elm=$(this),forElm;if(forSelector==="parent"){forElm=elm.parent()}else{forElm=$(forSelector)}elm.unbind("mousedown");elm.mousedown(function(){forElm.addClass("active")});elm.unbind("mouseup");elm.mouseup(function(){forElm.removeClass("active")})})}};return uiModule}();